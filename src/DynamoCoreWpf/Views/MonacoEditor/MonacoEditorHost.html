<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monaco Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #252526;
        }
        
        #editor-container {
            width: 100%;
            height: 100%;
        }
        
        /* Custom scrollbar styling to match VS Code */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4f4f4f;
        }
    </style>
</head>
<body>
    <div id="editor-container"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
        // Monaco Editor instance
        let editor = null;
        let currentLanguage = 'python';
        let isInitialized = false;
        
        // Configure Monaco loader
        require.config({ 
            paths: { 
                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' 
            }
        });
        
        // Language mapping for Dynamo node types
        const languageMap = {
            'python': 'python',
            'csharp': 'csharp',
            'designscript': 'javascript', // DesignScript syntax similar to JS
            'codeblock': 'javascript'     // Code blocks use DesignScript
        };
        
        // Initialize Monaco Editor
        require(['vs/editor/editor.main'], function() {
            // Register DesignScript as a custom language (based on JavaScript)
            monaco.languages.register({ id: 'designscript' });
            
            // Define DesignScript tokenization (simplified version)
            monaco.languages.setMonarchTokensProvider('designscript', {
                keywords: [
                    'def', 'return', 'if', 'elseif', 'else', 'for', 'while',
                    'true', 'false', 'null', 'Imperative', 'Associative'
                ],
                typeKeywords: [
                    'var', 'int', 'double', 'bool', 'string'
                ],
                operators: [
                    '=', '>', '<', '!', '~', '?', ':', '==', '<=', '>=', '!=',
                    '&&', '||', '++', '--', '+', '-', '*', '/', '&', '|', '^', '%',
                    '<<', '>>', '>>>', '+=', '-=', '*=', '/=', '&=', '|=', '^=',
                    '%=', '<<=', '>>=', '>>>='
                ],
                symbols: /[=><!~?:&|+\-*\/\^%]+/,
                tokenizer: {
                    root: [
                        [/[a-z_$][\w$]*/, { 
                            cases: { 
                                '@typeKeywords': 'keyword',
                                '@keywords': 'keyword',
                                '@default': 'identifier' 
                            } 
                        }],
                        [/[A-Z][\w\$]*/, 'type.identifier'],
                        { include: '@whitespace' },
                        [/[{}()\[\]]/, '@brackets'],
                        [/[<>](?!@symbols)/, '@brackets'],
                        [/@symbols/, { 
                            cases: { 
                                '@operators': 'operator',
                                '@default': '' 
                            } 
                        }],
                        [/\d*\.\d+([eE][\-+]?\d+)?/, 'number.float'],
                        [/\d+/, 'number'],
                        [/[;,.]/, 'delimiter'],
                        [/"([^"\\]|\\.)*$/, 'string.invalid'],
                        [/"/, { token: 'string.quote', bracket: '@open', next: '@string' }],
                    ],
                    string: [
                        [/[^\\"]+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/"/, { token: 'string.quote', bracket: '@close', next: '@pop' }]
                    ],
                    whitespace: [
                        [/[ \t\r\n]+/, 'white'],
                        [/\/\*/, 'comment', '@comment'],
                        [/\/\/.*$/, 'comment'],
                    ],
                    comment: [
                        [/[^\/*]+/, 'comment'],
                        [/\/\*/, 'comment', '@push'],
                        [/\*\//, 'comment', '@pop'],
                        [/[\/*]/, 'comment']
                    ],
                }
            });
            
            // Create the editor
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: '',
                language: currentLanguage,
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { 
                    enabled: true,
                    side: 'right',
                    showSlider: 'always',
                    renderCharacters: true,
                    maxColumn: 250
                },
                scrollBeyondLastLine: false,
                fontSize: 13,
                fontFamily: "'Source Code Pro', 'Consolas', 'Courier New', monospace",
                lineNumbers: 'on',
                renderWhitespace: 'selection',
                tabSize: 4,
                insertSpaces: true,
                wordWrap: 'off',
                folding: true,
                bracketPairColorization: { enabled: true },
                suggest: {
                    showMethods: true,
                    showFunctions: true,
                    showConstructors: true,
                    showFields: true,
                    showVariables: true,
                    showClasses: true,
                    showStructs: true,
                    showInterfaces: true,
                    showModules: true,
                    showProperties: true,
                    showEvents: true,
                    showOperators: true,
                    showUnits: true,
                    showValues: true,
                    showConstants: true,
                    showEnums: true,
                    showEnumMembers: true,
                    showKeywords: true,
                    showWords: true,
                    showColors: true,
                    showFiles: true,
                    showReferences: true,
                    showFolders: true,
                    showTypeParameters: true,
                    showSnippets: true
                },
                quickSuggestions: {
                    other: true,
                    comments: false,
                    strings: false
                },
                quickSuggestionsDelay: 10,
                suggestOnTriggerCharacters: true,
                acceptSuggestionOnCommitCharacter: true,
                acceptSuggestionOnEnter: 'on',
                tabCompletion: 'off',
                wordBasedSuggestions: 'matchingDocuments',
                parameterHints: { 
                    enabled: true,
                    cycle: false
                },
                formatOnPaste: true,
                formatOnType: true,
                hover: {
                    enabled: true,
                    delay: 300
                }
            });
            
            // Listen for content changes
            editor.onDidChangeModelContent(function(e) {
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage({
                        type: 'contentChanged',
                        content: editor.getValue()
                    });
                }
            });
            
            // Listen for cursor position changes
            editor.onDidChangeCursorPosition(function(e) {
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage({
                        type: 'cursorChanged',
                        line: e.position.lineNumber,
                        column: e.position.column
                    });
                }
            });
            
            // Listen for focus events
            editor.onDidFocusEditorText(function() {
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage({
                        type: 'editorFocused'
                    });
                }
            });
            
            editor.onDidBlurEditorText(function() {
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage({
                        type: 'editorBlurred'
                    });
                }
            });
            
            // Register IntelliSense providers for Python
            if (currentLanguage === 'python') {
                // Store pending requests
                const pendingCompletions = {};
                const pendingHovers = {};
                const pendingSignatures = {};
                
                // Global handlers for responses
                window.handleCompletionResponse = function(rid, completions) {
                    if (pendingCompletions[rid]) {
                        const { resolve, range } = pendingCompletions[rid];
                        delete pendingCompletions[rid];
                        
                        const suggestions = (completions || []).map(function(c) {
                            return {
                                label: c.label || c.text,
                                kind: monaco.languages.CompletionItemKind[c.kind] || monaco.languages.CompletionItemKind.Text,
                                insertText: c.insertText || c.text || c.label,
                                detail: c.detail || '',
                                documentation: {
                                    value: c.documentation || c.description || '',
                                    isTrusted: true
                                },
                                range: range,
                                sortText: c.sortText || c.label || c.text
                            };
                        });
                        
                        resolve({ suggestions: suggestions });
                    }
                };
                
                window.handleHoverResponse = function(rid, hoverInfo) {
                    if (pendingHovers[rid]) {
                        const { resolve } = pendingHovers[rid];
                        delete pendingHovers[rid];
                        resolve(hoverInfo);
                    }
                };
                
                window.handleSignatureResponse = function(rid, signatureInfo) {
                    if (pendingSignatures[rid]) {
                        const { resolve } = pendingSignatures[rid];
                        delete pendingSignatures[rid];
                        resolve(signatureInfo);
                    }
                };
                
                // 1. Completion Provider - Enhanced with more trigger characters
                monaco.languages.registerCompletionItemProvider('python', {
                    triggerCharacters: ['.'],
                    provideCompletionItems: function(model, position, context) {
                        return new Promise(function(resolve, reject) {
                            // When '.' is typed, Monaco triggers completion
                            // The position is AFTER the '.', so we need to get code including the '.'
                            const word = model.getWordUntilPosition(position);
                            const range = {
                                startLineNumber: position.lineNumber,
                                endLineNumber: position.lineNumber,
                                startColumn: word.startColumn,
                                endColumn: word.endColumn
                            };
                            
                            // Get code up to and including the cursor position
                            // Monaco's getValueInRange endColumn is exclusive, so position.column gives us up to (but not including) that column
                            // Since cursor is AFTER the '.', position.column includes the '.' in the range
                            let code = model.getValueInRange({
                                startLineNumber: 1,
                                startColumn: 1,
                                endLineNumber: position.lineNumber,
                                endColumn: position.column
                            });
                            
                            // Debug logging
                            console.log('Monaco completion triggered:', {
                                line: position.lineNumber,
                                column: position.column,
                                triggerCharacter: context.triggerCharacter,
                                codeLength: code.length,
                                codeEnd: code.substring(Math.max(0, code.length - 50))
                            });
                            
                            // Request completions from C#
                            const requestId = 'completion_' + Date.now() + '_' + Math.random();
                            pendingCompletions[requestId] = { resolve: resolve, range: range };
                            
                            // Set a timeout
                            setTimeout(function() {
                                if (pendingCompletions[requestId]) {
                                    console.log('Completion request timed out:', requestId);
                                    delete pendingCompletions[requestId];
                                    resolve({ suggestions: [] });
                                }
                            }, 5000);
                            
                            // Send completion request
                            if (window.chrome && window.chrome.webview) {
                                window.chrome.webview.postMessage({
                                    type: 'requestCompletions',
                                    requestId: requestId,
                                    code: code,
                                    line: position.lineNumber,
                                    column: position.column
                                });
                            } else {
                                console.log('WebView not available');
                                delete pendingCompletions[requestId];
                                resolve({ suggestions: [] });
                            }
                        });
                    }
                });
                
                // 2. Hover Provider - Show documentation on hover
                monaco.languages.registerHoverProvider('python', {
                    provideHover: function(model, position) {
                        return new Promise(function(resolve) {
                            const word = model.getWordAtPosition(position);
                            if (!word) {
                                resolve(null);
                                return;
                            }
                            
                            // Get code up to cursor
                            const code = model.getValueInRange({
                                startLineNumber: 1,
                                startColumn: 1,
                                endLineNumber: position.lineNumber,
                                endColumn: position.column
                            });
                            
                            const requestId = 'hover_' + Date.now() + '_' + Math.random();
                            pendingHovers[requestId] = { resolve: resolve };
                            
                            setTimeout(function() {
                                if (pendingHovers[requestId]) {
                                    delete pendingHovers[requestId];
                                    resolve(null);
                                }
                            }, 3000);
                            
                            if (window.chrome && window.chrome.webview) {
                                window.chrome.webview.postMessage({
                                    type: 'requestHover',
                                    requestId: requestId,
                                    code: code,
                                    word: word.word,
                                    line: position.lineNumber,
                                    column: position.column
                                });
                            } else {
                                delete pendingHovers[requestId];
                                resolve(null);
                            }
                        });
                    }
                });
                
                // 3. Signature Help Provider - Show function signatures
                monaco.languages.registerSignatureHelpProvider('python', {
                    signatureHelpTriggerCharacters: ['(', ','],
                    signatureHelpRetriggerCharacters: [','],
                    provideSignatureHelp: function(model, position) {
                        return new Promise(function(resolve) {
                            // Get code up to cursor
                            const code = model.getValueInRange({
                                startLineNumber: 1,
                                startColumn: 1,
                                endLineNumber: position.lineNumber,
                                endColumn: position.column
                            });
                            
                            // Check if we're in a function call (have '(' before cursor)
                            const lineText = model.getLineContent(position.lineNumber);
                            const textBeforeCursor = lineText.substring(0, position.column - 1);
                            const lastOpenParen = textBeforeCursor.lastIndexOf('(');
                            
                            if (lastOpenParen === -1) {
                                resolve(null);
                                return;
                            }
                            
                            // Extract function name
                            const beforeParen = textBeforeCursor.substring(0, lastOpenParen).trim();
                            const match = beforeParen.match(/(\w+(?:\.\w+)*)$/);
                            if (!match) {
                                resolve(null);
                                return;
                            }
                            
                            const functionName = match[1];
                            const requestId = 'signature_' + Date.now() + '_' + Math.random();
                            pendingSignatures[requestId] = { resolve: resolve };
                            
                            setTimeout(function() {
                                if (pendingSignatures[requestId]) {
                                    delete pendingSignatures[requestId];
                                    resolve(null);
                                }
                            }, 3000);
                            
                            if (window.chrome && window.chrome.webview) {
                                window.chrome.webview.postMessage({
                                    type: 'requestSignature',
                                    requestId: requestId,
                                    code: code,
                                    functionName: functionName,
                                    line: position.lineNumber,
                                    column: position.column
                                });
                            } else {
                                delete pendingSignatures[requestId];
                                resolve(null);
                            }
                        });
                    }
                });
            }
            
            isInitialized = true;
            
            // Notify host that editor is ready
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    type: 'editorReady'
                });
            }
        });
        
        // API functions callable from C#
        window.monacoApi = {
            // Set editor content
            setContent: function(content) {
                if (editor) {
                    editor.setValue(content || '');
                }
            },
            
            // Get editor content
            getContent: function() {
                return editor ? editor.getValue() : '';
            },
            
            // Set language mode
            setLanguage: function(language) {
                if (editor) {
                    const mappedLanguage = languageMap[language.toLowerCase()] || language;
                    currentLanguage = mappedLanguage;
                    monaco.editor.setModelLanguage(editor.getModel(), mappedLanguage);
                }
            },
            
            // Set read-only mode
            setReadOnly: function(readOnly) {
                if (editor) {
                    editor.updateOptions({ readOnly: readOnly });
                }
            },
            
            // Focus the editor
            focus: function() {
                if (editor) {
                    editor.focus();
                }
            },
            
            // Set font size
            setFontSize: function(size) {
                if (editor) {
                    editor.updateOptions({ fontSize: size });
                }
            },
            
            // Show/hide line numbers
            setLineNumbers: function(show) {
                if (editor) {
                    editor.updateOptions({ lineNumbers: show ? 'on' : 'off' });
                }
            },
            
            // Set word wrap
            setWordWrap: function(wrap) {
                if (editor) {
                    editor.updateOptions({ wordWrap: wrap ? 'on' : 'off' });
                }
            },
            
            // Set theme
            setTheme: function(theme) {
                if (editor) {
                    monaco.editor.setTheme(theme);
                }
            },
            
            // Insert text at cursor
            insertText: function(text) {
                if (editor) {
                    const selection = editor.getSelection();
                    const range = new monaco.Range(
                        selection.startLineNumber,
                        selection.startColumn,
                        selection.endLineNumber,
                        selection.endColumn
                    );
                    editor.executeEdits('', [{ range: range, text: text }]);
                }
            },
            
            // Register completion items provider (called from C#)
            registerCompletions: function(completions) {
                if (!editor) return;
                
                // completions is an array of { label, kind, insertText, detail, documentation }
                monaco.languages.registerCompletionItemProvider(currentLanguage, {
                    provideCompletionItems: function(model, position) {
                        const word = model.getWordUntilPosition(position);
                        const range = {
                            startLineNumber: position.lineNumber,
                            endLineNumber: position.lineNumber,
                            startColumn: word.startColumn,
                            endColumn: word.endColumn
                        };
                        
                        return {
                            suggestions: completions.map(function(c) {
                                return {
                                    label: c.label,
                                    kind: monaco.languages.CompletionItemKind[c.kind] || monaco.languages.CompletionItemKind.Text,
                                    insertText: c.insertText || c.label,
                                    detail: c.detail,
                                    documentation: c.documentation,
                                    range: range
                                };
                            })
                        };
                    }
                });
            },
            
            // Undo
            undo: function() {
                if (editor) {
                    editor.trigger('keyboard', 'undo', null);
                }
            },
            
            // Redo
            redo: function() {
                if (editor) {
                    editor.trigger('keyboard', 'redo', null);
                }
            },
            
            // Select all
            selectAll: function() {
                if (editor) {
                    editor.setSelection(editor.getModel().getFullModelRange());
                }
            },
            
            // Format document
            formatDocument: function() {
                if (editor) {
                    editor.getAction('editor.action.formatDocument').run();
                }
            },
            
            // Check if editor is ready
            isReady: function() {
                return isInitialized && editor !== null;
            }
        };
    </script>
</body>
</html>

