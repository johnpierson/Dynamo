<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monaco Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #252526;
        }
        
        #editor-container {
            width: 100%;
            height: 100%;
        }
        
        /* Custom scrollbar styling to match VS Code */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4f4f4f;
        }
    </style>
</head>
<body>
    <div id="editor-container"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
        // Monaco Editor instance
        let editor = null;
        let currentLanguage = 'python';
        let isInitialized = false;
        
        // Configure Monaco loader
        require.config({ 
            paths: { 
                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' 
            }
        });
        
        // Language mapping for Dynamo node types
        const languageMap = {
            'python': 'python',
            'csharp': 'csharp',
            'designscript': 'javascript', // DesignScript syntax similar to JS
            'codeblock': 'javascript'     // Code blocks use DesignScript
        };
        
        // Initialize Monaco Editor
        require(['vs/editor/editor.main'], function() {
            // Register DesignScript as a custom language (based on JavaScript)
            monaco.languages.register({ id: 'designscript' });
            
            // Define DesignScript tokenization (simplified version)
            monaco.languages.setMonarchTokensProvider('designscript', {
                keywords: [
                    'def', 'return', 'if', 'elseif', 'else', 'for', 'while',
                    'true', 'false', 'null', 'Imperative', 'Associative'
                ],
                typeKeywords: [
                    'var', 'int', 'double', 'bool', 'string'
                ],
                operators: [
                    '=', '>', '<', '!', '~', '?', ':', '==', '<=', '>=', '!=',
                    '&&', '||', '++', '--', '+', '-', '*', '/', '&', '|', '^', '%',
                    '<<', '>>', '>>>', '+=', '-=', '*=', '/=', '&=', '|=', '^=',
                    '%=', '<<=', '>>=', '>>>='
                ],
                symbols: /[=><!~?:&|+\-*\/\^%]+/,
                tokenizer: {
                    root: [
                        [/[a-z_$][\w$]*/, { 
                            cases: { 
                                '@typeKeywords': 'keyword',
                                '@keywords': 'keyword',
                                '@default': 'identifier' 
                            } 
                        }],
                        [/[A-Z][\w\$]*/, 'type.identifier'],
                        { include: '@whitespace' },
                        [/[{}()\[\]]/, '@brackets'],
                        [/[<>](?!@symbols)/, '@brackets'],
                        [/@symbols/, { 
                            cases: { 
                                '@operators': 'operator',
                                '@default': '' 
                            } 
                        }],
                        [/\d*\.\d+([eE][\-+]?\d+)?/, 'number.float'],
                        [/\d+/, 'number'],
                        [/[;,.]/, 'delimiter'],
                        [/"([^"\\]|\\.)*$/, 'string.invalid'],
                        [/"/, { token: 'string.quote', bracket: '@open', next: '@string' }],
                    ],
                    string: [
                        [/[^\\"]+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/"/, { token: 'string.quote', bracket: '@close', next: '@pop' }]
                    ],
                    whitespace: [
                        [/[ \t\r\n]+/, 'white'],
                        [/\/\*/, 'comment', '@comment'],
                        [/\/\/.*$/, 'comment'],
                    ],
                    comment: [
                        [/[^\/*]+/, 'comment'],
                        [/\/\*/, 'comment', '@push'],
                        [/\*\//, 'comment', '@pop'],
                        [/[\/*]/, 'comment']
                    ],
                }
            });
            
            // Create the editor
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: '',
                language: currentLanguage,
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                fontSize: 13,
                fontFamily: "'Source Code Pro', 'Consolas', 'Courier New', monospace",
                lineNumbers: 'on',
                renderWhitespace: 'selection',
                tabSize: 4,
                insertSpaces: true,
                wordWrap: 'off',
                folding: true,
                bracketPairColorization: { enabled: true },
                suggest: {
                    showMethods: true,
                    showFunctions: true,
                    showConstructors: true,
                    showFields: true,
                    showVariables: true,
                    showClasses: true,
                    showStructs: true,
                    showInterfaces: true,
                    showModules: true,
                    showProperties: true,
                    showEvents: true,
                    showOperators: true,
                    showUnits: true,
                    showValues: true,
                    showConstants: true,
                    showEnums: true,
                    showEnumMembers: true,
                    showKeywords: true,
                    showWords: true,
                    showColors: true,
                    showFiles: true,
                    showReferences: true,
                    showFolders: true,
                    showTypeParameters: true,
                    showSnippets: true
                },
                quickSuggestions: {
                    other: true,
                    comments: false,
                    strings: false
                },
                parameterHints: { enabled: true },
                formatOnPaste: true,
                formatOnType: true
            });
            
            // Listen for content changes
            editor.onDidChangeModelContent(function(e) {
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage({
                        type: 'contentChanged',
                        content: editor.getValue()
                    });
                }
            });
            
            // Listen for cursor position changes
            editor.onDidChangeCursorPosition(function(e) {
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage({
                        type: 'cursorChanged',
                        line: e.position.lineNumber,
                        column: e.position.column
                    });
                }
            });
            
            // Listen for focus events
            editor.onDidFocusEditorText(function() {
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage({
                        type: 'editorFocused'
                    });
                }
            });
            
            editor.onDidBlurEditorText(function() {
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage({
                        type: 'editorBlurred'
                    });
                }
            });
            
            isInitialized = true;
            
            // Notify host that editor is ready
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    type: 'editorReady'
                });
            }
        });
        
        // API functions callable from C#
        window.monacoApi = {
            // Set editor content
            setContent: function(content) {
                if (editor) {
                    editor.setValue(content || '');
                }
            },
            
            // Get editor content
            getContent: function() {
                return editor ? editor.getValue() : '';
            },
            
            // Set language mode
            setLanguage: function(language) {
                if (editor) {
                    const mappedLanguage = languageMap[language.toLowerCase()] || language;
                    currentLanguage = mappedLanguage;
                    monaco.editor.setModelLanguage(editor.getModel(), mappedLanguage);
                }
            },
            
            // Set read-only mode
            setReadOnly: function(readOnly) {
                if (editor) {
                    editor.updateOptions({ readOnly: readOnly });
                }
            },
            
            // Focus the editor
            focus: function() {
                if (editor) {
                    editor.focus();
                }
            },
            
            // Set font size
            setFontSize: function(size) {
                if (editor) {
                    editor.updateOptions({ fontSize: size });
                }
            },
            
            // Show/hide line numbers
            setLineNumbers: function(show) {
                if (editor) {
                    editor.updateOptions({ lineNumbers: show ? 'on' : 'off' });
                }
            },
            
            // Set word wrap
            setWordWrap: function(wrap) {
                if (editor) {
                    editor.updateOptions({ wordWrap: wrap ? 'on' : 'off' });
                }
            },
            
            // Set theme
            setTheme: function(theme) {
                if (editor) {
                    monaco.editor.setTheme(theme);
                }
            },
            
            // Insert text at cursor
            insertText: function(text) {
                if (editor) {
                    const selection = editor.getSelection();
                    const range = new monaco.Range(
                        selection.startLineNumber,
                        selection.startColumn,
                        selection.endLineNumber,
                        selection.endColumn
                    );
                    editor.executeEdits('', [{ range: range, text: text }]);
                }
            },
            
            // Register completion items provider (called from C#)
            registerCompletions: function(completions) {
                if (!editor) return;
                
                // completions is an array of { label, kind, insertText, detail, documentation }
                monaco.languages.registerCompletionItemProvider(currentLanguage, {
                    provideCompletionItems: function(model, position) {
                        const word = model.getWordUntilPosition(position);
                        const range = {
                            startLineNumber: position.lineNumber,
                            endLineNumber: position.lineNumber,
                            startColumn: word.startColumn,
                            endColumn: word.endColumn
                        };
                        
                        return {
                            suggestions: completions.map(function(c) {
                                return {
                                    label: c.label,
                                    kind: monaco.languages.CompletionItemKind[c.kind] || monaco.languages.CompletionItemKind.Text,
                                    insertText: c.insertText || c.label,
                                    detail: c.detail,
                                    documentation: c.documentation,
                                    range: range
                                };
                            })
                        };
                    }
                });
            },
            
            // Undo
            undo: function() {
                if (editor) {
                    editor.trigger('keyboard', 'undo', null);
                }
            },
            
            // Redo
            redo: function() {
                if (editor) {
                    editor.trigger('keyboard', 'redo', null);
                }
            },
            
            // Select all
            selectAll: function() {
                if (editor) {
                    editor.setSelection(editor.getModel().getFullModelRange());
                }
            },
            
            // Format document
            formatDocument: function() {
                if (editor) {
                    editor.getAction('editor.action.formatDocument').run();
                }
            },
            
            // Check if editor is ready
            isReady: function() {
                return isInitialized && editor !== null;
            }
        };
    </script>
</body>
</html>

